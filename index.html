<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prompt Mama • Prompt Library</title>
<meta name="description" content="Prompt Mama—your searchable prompt library with topics, tags, and drag & drop." />
<style>
  :root{
    /* Prompt Mama brand */
    --pm-pink:#ff4fa3;
    --pm-pink-2:#ff6ab3;
    --pm-sky:#bde6ff;
    --pm-sky-2:#9fdcff;
    --bg: #081017;
    --panel: #0f1620;
    --text: #f6f7fb;
    --muted:#a8b3c7;
    --chip:#121b27;
    --chip-active:#172232;
    --border:#233144;
    --shadow: 0 10px 35px rgba(0,0,0,.45);
    --radius: 16px;
    --ok:#39d98a;
    --danger:#ff5c7c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 80% -10%, rgba(255,105,180,.12), transparent 60%),
      radial-gradient(1200px 700px at -10% 10%, rgba(152,225,255,.12), transparent 60%),
      linear-gradient(180deg,#071018 0%, #0b1621 55%, #090f15 100%);
    color:var(--text);
    font: 15px/1.55 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  .app{max-width:1100px; margin:32px auto; padding:0 16px 100px}

  header{display:flex; align-items:center; gap:14px; margin-bottom:18px}
  .logo{
    width:48px; height:48px; border-radius:12px; flex:0 0 48px; position:relative;
    background:linear-gradient(180deg,var(--pm-sky),var(--pm-sky-2));
    box-shadow: 0 8px 22px rgba(159,220,255,.35), inset 0 0 0 2px rgba(255,255,255,.5);
  }
  /* speech bubble + heart */
  .logo:before{
    content:""; position:absolute; inset:9px 9px 15px 9px; border-radius:10px;
    background:#0a1320; box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
  }
  .logo:after{
    content:""; position:absolute; width:14px; height:14px; left:26px; top:8px; transform:rotate(45deg);
    background: radial-gradient(circle at 30% 30%, #fff 0 10%, transparent 11% 100%), var(--pm-pink);
    border-radius:4px 10px 10px 10px;
    box-shadow: 0 0 10px rgba(255,79,163,.6);
  }

  .title-wrap{flex:1}
  h1{margin:0; font-size:22px; letter-spacing:.2px}
  .subtitle{margin:4px 0 0; color:var(--muted); font-size:13px}
  .mark{color:var(--pm-pink); font-weight:700}

  .actions{display:flex; gap:10px; flex-wrap:wrap}
  button, .btn{
    appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text);
    padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s transform ease, .2s background;
  }
  button:hover{transform:translateY(-1px); background:#121c28}
  .btn-primary{
    background:linear-gradient(180deg, var(--pm-pink), var(--pm-pink-2)); border-color:#ff86c7; color:#1a0c14;
    font-weight:700;
  }
  .btn-primary:hover{filter:saturate(1.1) brightness(1.03)}
  .btn-danger{background:linear-gradient(180deg, #ff6187, #ff3e6c); border-color:#ff4b78}

  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}

  .searchbar{
    display:flex; gap:10px; align-items:center; background:var(--panel); border:1px solid var(--border);
    border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); margin:14px 0 10px;
  }
  .searchbar input{
    flex:1; background:transparent; border:0; color:var(--text); outline:none; font-size:15px;
  }
  select{
    background:#111a26; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }

  .topic-bar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 18px}
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    background:var(--chip); border:1px solid var(--border); color:var(--text); cursor:pointer; user-select:none;
    transition:.15s transform ease, .2s background;
  }
  .chip:hover{transform:translateY(-1px)}
  .chip.active{background:var(--chip-active); border-color:#2c3950; box-shadow: inset 0 0 0 1px #2b3a52}

  .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:16px}
  .card{
    grid-column: span 6; background:linear-gradient(180deg,#0f1722,#0c141d);
    border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
    display:flex; flex-direction:column; gap:10px; min-height:180px; position:relative;
  }
  @media (max-width:880px){ .card{grid-column: span 12;} }

  .card.dragging{opacity:.6; outline:2px dashed var(--pm-pink)}
  .drop-indicator{height:10px; margin:-6px 0 6px; border-radius:8px; background:linear-gradient(90deg,var(--pm-pink), var(--pm-sky)); opacity:.75}

  .card h3{margin:0; font-size:17px}
  .meta{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
  .tags{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:12px; padding:4px 8px; border-radius:999px; background:#141f2c; border:1px solid #273447; color:#dbe7ff}

  .prompt{white-space:pre-wrap; background:#0d1723; border:1px dashed #243149; padding:12px; border-radius:12px; color:#e9f1ff}
  .card-footer{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px}
  .left-actions, .right-actions{display:flex; gap:8px; align-items:center}
  .icon-btn{background:#0f1a28; border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer}
  .icon-btn:hover{background:#132132}
  .fav.active{background:#201a2a; border-color:#3b2a55}

  .empty{
    text-align:center; color:var(--muted); padding:38px 12px; border:1px dashed var(--border); border-radius:14px;
  }
  .divider{height:1px; background:linear-gradient(90deg, transparent, #223045, transparent); margin:12px 0}
  .note{font-size:12px; color:var(--muted)}
  .kbd{font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; background:#101b29; border:1px solid #2a3b56; padding:2px 6px; border-radius:6px}
  a.link{color:#ffd0ea; text-decoration:none}
  a.link:hover{text-decoration:underline}

  /* Modal */
  dialog{
    border:1px solid var(--border); border-radius:18px; background:linear-gradient(180deg,#0c131d,#0a121a);
    color:var(--text); width:min(760px, 92vw); box-shadow:var(--shadow); padding:0;
  }
  .modal-head{padding:16px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border)}
  .modal-body{padding:18px}
  .form{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
  .form .full{grid-column:1/-1}
  label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
  input[type="text"], textarea{
    width:100%; padding:10px 12px; background:#0b1521; border:1px solid #23334a; color:var(--text); border-radius:10px;
  }
  textarea{min-height:130px; resize:vertical}
  .modal-foot{display:flex; justify-content:space-between; gap:10px; padding:14px 18px; border-top:1px solid var(--border); background:#0c131d; border-radius:0 0 18px 18px}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div class="title-wrap">
        <h1>Prompt <span class="mark">Mama</span> • Prompt Library</h1>
        <p class="subtitle">Add prompts. Tag by topic. Search fast. <strong>Manual drag & drop</strong> when you want your own order.</p>
      </div>
      <div class="actions">
        <button id="addBtn" class="btn-primary" title="Add a new prompt (N)">＋ New</button>
        <button id="exportBtn" class="btn" title="Export library to JSON">Export</button>
        <label class="btn" style="cursor:pointer" title="Import a library JSON file">
          Import <input id="importInput" type="file" accept="application/json" hidden />
        </label>
        <button id="clearBtn" class="btn-danger" title="Delete all prompts">Clear</button>
      </div>
    </header>

    <div class="row searchbar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#9aa3b2" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="searchInput" type="text" placeholder="Search title, prompt, or notes… (⌘/Ctrl+K)" />
      <div class="row" style="margin-left:auto">
        <span class="note">Sort</span>
        <select id="sortSelect" title="Sort prompts">
          <option value="updated-desc">Recently updated</option>
          <option value="created-desc">Newest</option>
          <option value="title-asc">Title A → Z</option>
          <option value="title-desc">Title Z → A</option>
          <option value="manual">Manual (drag & drop)</option>
        </select>
      </div>
    </div>

    <div id="topicBar" class="topic-bar" aria-label="Topic filters"></div>

    <div id="results" class="grid"></div>

    <p class="note">Tips: Press <span class="kbd">N</span> to add, <span class="kbd">/</span> or <span class="kbd">⌘/Ctrl+K</span> to search, <span class="kbd">E</span> to edit a selected card, click a topic chip to filter. Switch “Sort” to <strong>Manual</strong> to drag & drop.</p>
    <div class="divider"></div>
    <p class="note">Your prompts live in <strong>localStorage</strong> only. Use Export to back them up, or Import to merge a JSON file.</p>
  </div>

  <!-- Modal -->
  <dialog id="promptModal">
    <form method="dialog" id="promptForm">
      <div class="modal-head">
        <strong id="modalTitle">New Prompt</strong>
        <button class="icon-btn" type="button" id="closeModal" title="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="form">
          <div class="full">
            <label for="title">Title</label>
            <input id="title" type="text" placeholder="e.g., Back-to-school morning routine (2nd grade)" required />
          </div>
          <div class="full">
            <label for="topics">Topics (comma separated)</label>
            <input id="topics" type="text" placeholder="e.g., parenting, travel, content" />
          </div>
          <div class="full">
            <label for="prompt">Prompt</label>
            <textarea id="prompt" placeholder="Paste your prompt here…" required></textarea>
          </div>
          <div>
            <label for="audience">Audience</label>
            <input id="audience" type="text" placeholder="e.g., moms of toddlers, AEs, designers" />
          </div>
          <div>
            <label for="usecase">Use case</label>
            <input id="usecase" type="text" placeholder="e.g., caption writing, itinerary planning" />
          </div>
          <div class="full">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Any context, examples, or variables to customize…"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <div class="note">Separate multiple topics with commas. You can edit later.</div>
        <div style="display:flex; gap:8px">
          <button type="button" class="btn" id="resetForm">Reset</button>
          <button type="submit" class="btn-primary" id="saveBtn">Save Prompt</button>
        </div>
      </div>
      <input type="hidden" id="editingId" />
    </form>
  </dialog>

<script>
(function(){
  const STORAGE_KEY = 'promptMamaLibraryV2'; // bumped for branding + manual order
  const el = (sel, root=document) => root.querySelector(sel);
  const els = (sel, root=document) => [...root.querySelectorAll(sel)];
  const state = {
    items: [],
    search: '',
    topicsFilter: new Set(),
    sort: 'updated-desc'
  };

  // --- Utilities
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
  const now = () => new Date().toISOString();
  const normalizeTopics = (str) =>
    (str || '')
      .split(',')
      .map(t => t.trim().toLowerCase())
      .filter(Boolean)
      .slice(0, 12);

  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
  const load = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch { return []; }
  };

  const seedIfEmpty = () => {
    if (state.items.length) return;
    const baseOrder = (i) => i + 1;
    const seeds = [
      {
        title: "Back-to-School Morning Routine (2nd Grade)",
        topics: ["parenting","routines","school"],
        prompt:
`You are a warm, encouraging family assistant.
Create a 20–25 minute **school morning** plan for a 2nd grader who needs a slow start.
Constraints:
- Bus pickup: 7:14 AM (be at corner by 7:11)
- Include a 5-minute buffer and hair time
- Breakfast ideas (bagel, muffin, fruit)
- Provide 3 “grab & go” backups
Return:
1) Timestamped checklist
2) 1-sentence pep talk
3) 3 tiny contingency tips if we’re running late`,
        audience:"Parents (elementary)",
        usecase:"Daily schedule",
        notes:"Customize wake time based on today.",
        favorite: true
      },
      {
        title: "Travel Day with Toddler (Screen-Light)",
        topics: ["parenting","travel","toddlers"],
        prompt:
`Plan a travel day for a 3-year-old with 30–45 min blocks.
Include: screen-free rotations, snack plan, stretch breaks, calm-down toolkit.
Deliver: printable timeline + packing mini-checklist.`,
        audience:"Parents of toddlers",
        usecase:"Trip planning",
        notes:"Great for flights & road trips."
      },
      {
        title: "Instagram Carousel: Data ➜ Story (Prompt Mama Style)",
        topics: ["social","content","marketing"],
        prompt:
`Turn the stats I paste below into a 6-slide carousel in Prompt Mama voice.
S1: bold hook (no jargon)
S2–S4: key stats + plain-English takeaway
S5: “how to use this today”
S6: CTA to follow for more + save/share nudge
Keep it punchy, friendly, helpful.`,
        audience:"Moms, creators, marketers",
        usecase:"Social content",
        notes:"Paste data below this prompt."
      },
      {
        title: "Solo Parenting Day Plan (One Grownup Sick)",
        topics: ["parenting","routines","wellness"],
        prompt:
`Create a flexible day plan for two kids (7 & 3) when my partner needs rest.
Include:
- School/daycare logistics
- Quiet play blocks
- 5 fast meals/snacks (minimal cleanup)
- 3 text check-ins that feel caring (no germ sharing)
- 5-min self-care moment for me
Format as sections with times.`,
        audience:"Parents",
        usecase:"Daily plan",
        notes:"Keep it realistic; we’re tired."
      },
      {
        title: "Prompt Mama Caption Helper (Hook → Heart → Help → CTA)",
        topics: ["social","writing","prompt-mama"],
        prompt:
`Write a 90–130 word caption in this flow:
1) HOOK: a quick, relatable line for moms (no shaming)
2) HEART: one sentence of empathy or funny realness
3) HELP: 2–3 practical tips or a tiny framework
4) CTA: save/share/follow
Tone: bright, human, encouraging. Use 3–5 emojis max.`
      }
    ].map((s, i)=>({
      id: uid(),
      createdAt: now(),
      updatedAt: now(),
      order: baseOrder(i),
      favorite:false,
      ...s
    }));
    state.items = seeds;
    save();
  };

  const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  // --- Render
  const resultsEl = el('#results');
  const topicBarEl = el('#topicBar');

  function buildTopicIndex(items){
    const counts = {};
    items.forEach(i => (i.topics||[]).forEach(t => counts[t] = (counts[t]||0)+1));
    return Object.entries(counts).sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function renderTopics(){
    topicBarEl.innerHTML = '';
    const all = buildTopicIndex(state.items);
    if (!all.length){ return; }
    const allChip = chipEl('All', state.topicsFilter.size===0, ()=>{ state.topicsFilter.clear(); render(); });
    topicBarEl.appendChild(allChip);
    all.forEach(([topic, count])=>{
      const ch = chipEl(`${topic} <span class="note">· ${count}</span>`, state.topicsFilter.has(topic), ()=>{
        if (state.topicsFilter.has(topic)) state.topicsFilter.delete(topic); else state.topicsFilter.add(topic);
        render();
      });
      topicBarEl.appendChild(ch);
    });
    if (state.topicsFilter.size){
      topicBarEl.appendChild(chipEl('Clear filters', false, ()=>{ state.topicsFilter.clear(); render(); }));
    }
  }
  function chipEl(html, active, onClick){
    const b = document.createElement('button');
    b.className = 'chip' + (active ? ' active':''); b.innerHTML = html; b.onclick = onClick; return b;
  }

  function matchesSearch(item, q){
    if (!q) return true;
    const hay = [
      item.title, item.prompt, item.notes, item.audience, item.usecase,
      ...(item.topics || [])
    ].join(' ').toLowerCase();
    return hay.includes(q.toLowerCase());
  }
  function matchesTopics(item){ return state.topicsFilter.size===0 || (item.topics||[]).some(t=>state.topicsFilter.has(t)); }

  function sortItems(items){
    const s = state.sort;
    const sorted = [...items];
    if (s === 'manual') sorted.sort((a,b)=>(a.order||0)-(b.order||0));
    else if (s === 'updated-desc') sorted.sort((a,b)=>b.updatedAt.localeCompare(a.updatedAt));
    else if (s === 'created-desc') sorted.sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
    else if (s === 'title-asc') sorted.sort((a,b)=>a.title.localeCompare(b.title));
    else if (s === 'title-desc') sorted.sort((a,b)=>b.title.localeCompare(a.title));
    return sorted;
  }

  function render(){
    renderTopics();
    const filtered = state.items.filter(i => matchesSearch(i, state.search) && matchesTopics(i));
    const items = sortItems(filtered);

    resultsEl.innerHTML = '';
    if (!items.length){
      resultsEl.innerHTML = `<div class="card empty" style="grid-column:1/-1">
        <div style="font-size:16px; margin-bottom:6px">No prompts found</div>
        <div class="note">Try clearing topic filters or adjusting your search. Click “＋ New” to add one.</div>
      </div>`;
      return;
    }

    items.forEach(it => {
      const card = document.createElement('div');
      card.className = 'card';
      card.tabIndex = 0;
      card.setAttribute('data-id', it.id);

      // drag & drop only in manual mode
      if (state.sort === 'manual'){
        card.setAttribute('draggable', 'true');
        enableDragHandlers(card);
      } else {
        card.removeAttribute('draggable');
      }

      const h = document.createElement('div');
      h.className = 'row';
      h.style.justifyContent='space-between';
      h.innerHTML = `<h3>${escapeHtml(it.title)}</h3>
        <div class="row" style="gap:8px">
          ${state.sort==='manual' ? `<span class="note">⇅ drag</span>`:``}
          <div class="note" title="Updated">${new Date(it.updatedAt).toLocaleDateString()}</div>
        </div>`;
      card.appendChild(h);

      const meta = document.createElement('div');
      meta.className = 'meta';
      const aud = it.audience ? `<span>👥 ${escapeHtml(it.audience)}</span>` : '';
      const use = it.usecase ? `<span>🧩 ${escapeHtml(it.usecase)}</span>` : '';
      meta.innerHTML = `${aud} ${use}`;
      card.appendChild(meta);

      if (it.topics?.length){
        const tags = document.createElement('div');
        tags.className = 'tags';
        it.topics.forEach(t=>{
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = t;
          tag.style.cursor='pointer';
          tag.title = `Filter by ${t}`;
          tag.onclick = () => { state.topicsFilter.add(t); render(); };
          tags.appendChild(tag);
        });
        card.appendChild(tags);
      }

      const pre = document.createElement('div');
      pre.className = 'prompt';
      pre.textContent = it.prompt;
      card.appendChild(pre);

      if (it.notes){
        const notes = document.createElement('div');
        notes.className = 'note';
        notes.textContent = it.notes;
        card.appendChild(notes);
      }

      const footer = document.createElement('div');
      footer.className = 'card-footer';

      const left = document.createElement('div'); left.className = 'left-actions';
      const copyBtn = button('Copy', ()=> copyPrompt(it));
      const editBtn = button('Edit', ()=> openEdit(it.id));
      const delBtn = button('Delete', ()=> remove(it.id), 'icon-btn');
      delBtn.classList.add('btn-danger');
      left.append(copyBtn, editBtn, delBtn);

      const right = document.createElement('div'); right.className = 'right-actions';
      const favBtn = button(it.favorite ? '★ Favorited' : '☆ Favorite', ()=> toggleFav(it.id));
      favBtn.classList.add('fav'); if (it.favorite) favBtn.classList.add('active');
      const exportOne = button('Export', ()=> exportSingle(it.id));
      right.append(favBtn, exportOne);

      footer.append(left, right);
      card.appendChild(footer);

      resultsEl.appendChild(card);
    });
  }

  function button(label, onClick, cls='icon-btn'){ const b=document.createElement('button'); b.type='button'; b.className=cls; b.textContent=label; b.onclick=onClick; return b; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // --- CRUD
  function upsert(item){
    const idx = state.items.findIndex(x=>x.id===item.id);
    if (idx >= 0){ state.items[idx] = item; }
    else { state.items.push(item); }
    save(); render();
  }
  function remove(id){
    if (!confirm('Delete this prompt?')) return;
    state.items = state.items.filter(x=>x.id!==id); save(); render();
  }
  function toggleFav(id){
    const it = state.items.find(x=>x.id===id); if (!it) return;
    it.favorite = !it.favorite; it.updatedAt = now(); upsert(it);
  }

  // --- Clipboard & export/import
  async function copyPrompt(it){
    const text = it.prompt;
    try{
      await navigator.clipboard.writeText(text);
      toast('Prompt copied!');
    }catch{ fallbackCopy(text); toast('Copied (fallback).'); }
  }
  function fallbackCopy(text){
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
  function downloadJSON(filename, data){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  }
  function exportAll(){ downloadJSON('prompt-mama-library.json', state.items); }
  function exportSingle(id){
    const it = state.items.find(x=>x.id===id); if (!it) return;
    downloadJSON(`${slugify(it.title)}.json`, it);
  }
  function slugify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,60) || 'prompt'; }
  function importFile(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = JSON.parse(e.target.result);
        const toAdd = Array.isArray(data) ? data : [data];
        let added = 0;
        toAdd.forEach(obj=>{
          const item = sanitizeImport(obj);
          if (!item) return;
          // de-dupe by title+prompt
          const dupe = state.items.find(x => x.title === item.title && x.prompt === item.prompt);
          if (dupe){
            item.id = dupe.id;
            item.createdAt = dupe.createdAt;
            item.order = dupe.order;
          } else if (!item.order){
            item.order = (state.items.reduce((m,i)=>Math.max(m, i.order||0),0) + 1);
          }
          upsert(item); added++;
        });
        toast(`Imported ${added} prompt${added===1?'':'s'}.`);
      }catch(err){ alert('Invalid JSON file.'); }
    };
    reader.readAsText(file);
  }
  function sanitizeImport(obj){
    if (!obj || typeof obj !== 'object') return null;
    const id = obj.id || uid();
    return {
      id,
      title: String(obj.title || 'Untitled'),
      topics: normalizeTopics((obj.topics || []).join ? obj.topics.join(',') : obj.topics),
      prompt: String(obj.prompt || ''),
      audience: obj.audience ? String(obj.audience) : '',
      usecase: obj.usecase ? String(obj.usecase) : '',
      notes: obj.notes ? String(obj.notes) : '',
      createdAt: obj.createdAt || now(),
      updatedAt: now(),
      favorite: !!obj.favorite,
      order: typeof obj.order==='number' ? obj.order : undefined
    };
  }

  // --- Modal handlers
  const modal = el('#promptModal');
  const addBtn = el('#addBtn');
  const resetBtn = el('#resetForm');
  const closeBtn = el('#closeModal');
  const importInput = el('#importInput');
  const exportBtn = el('#exportBtn');
  const clearBtn = el('#clearBtn');

  addBtn.onclick = () => openNew();
  exportBtn.onclick = () => exportAll();
  clearBtn.onclick = ()=>{
    if (!confirm('This will delete ALL prompts in your library. Proceed?')) return;
    state.items = []; save(); render(); toast('Library cleared.');
  };
  importInput.onchange = (e)=> { const file = e.target.files?.[0]; if (file) importFile(file); e.target.value=''; };
  closeBtn.onclick = ()=> modal.close();
  resetBtn.onclick = ()=> (el('#promptForm').reset());

  el('#promptForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const editingId = el('#editingId').value.trim();
    const item = {
      id: editingId || uid(),
      title: el('#title').value.trim(),
      topics: normalizeTopics(el('#topics').value),
      prompt: el('#prompt').value,
      audience: el('#audience').value.trim(),
      usecase: el('#usecase').value.trim(),
      notes: el('#notes').value.trim(),
      createdAt: editingId ? state.items.find(x=>x.id===editingId)?.createdAt || now() : now(),
      updatedAt: now(),
      favorite: state.items.find(x=>x.id===editingId)?.favorite || false,
      order: editingId
        ? (state.items.find(x=>x.id===editingId)?.order ?? calcNextOrder())
        : calcNextOrder()
    };
    if (!item.title || !item.prompt){ alert('Please add a title and a prompt.'); return; }
    upsert(item);
    modal.close();
    toast(editingId ? 'Prompt updated.' : 'Prompt added.');
    el('#promptForm').reset();
  });

  function calcNextOrder(){ return (state.items.reduce((m,i)=>Math.max(m, i.order||0),0) + 1); }

  function openNew(){
    el('#modalTitle').textContent = 'New Prompt';
    el('#editingId').value = '';
    el('#promptForm').reset();
    modal.showModal();
    setTimeout(()=>el('#title').focus(), 50);
  }
  function openEdit(id){
    const it = state.items.find(x=>x.id===id); if (!it) return;
    el('#modalTitle').textContent = 'Edit Prompt';
    el('#editingId').value = it.id;
    el('#title').value = it.title;
    el('#topics').value = (it.topics || []).join(', ');
    el('#prompt').value = it.prompt;
    el('#audience').value = it.audience || '';
    el('#usecase').value = it.usecase || '';
    el('#notes').value = it.notes || '';
    modal.showModal();
    setTimeout(()=>el('#title').focus(), 50);
  }

  // --- Search & sort
  const searchInput = el('#searchInput');
  const sortSelect = el('#sortSelect');
  sortSelect.onchange = ()=> { state.sort = sortSelect.value; render(); };
  searchInput.addEventListener('input', debounce(()=>{
    state.search = searchInput.value.trim();
    render();
  }, 120));

  // --- Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if (e.key.toLowerCase() === 'n'){ e.preventDefault(); openNew(); }
    if (e.key === '/' || (e.key.toLowerCase()==='k' && (e.metaKey||e.ctrlKey))){
      e.preventDefault(); searchInput.focus(); searchInput.select();
    }
    if (e.key.toLowerCase()==='e'){
      const sel = document.activeElement?.closest('.card');
      if (sel){ openEdit(sel.getAttribute('data-id')); }
    }
  });

  // --- Drag & Drop (manual sort)
  let dragId = null, dropIndicator = null;

  function enableDragHandlers(card){
    card.addEventListener('dragstart', (e)=>{
      dragId = card.getAttribute('data-id');
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', ()=>{
      card.classList.remove('dragging');
      dragId = null;
      removeDropIndicator();
    });
    card.addEventListener('dragover', (e)=>{
      e.preventDefault();
      if (!dragId) return;
      const over = card;
      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      showDropIndicator(over, before);
    });
    card.addEventListener('drop', (e)=>{
      e.preventDefault();
      if (!dragId) return;
      const targetId = card.getAttribute('data-id');
      if (targetId === dragId) return;
      const rect = card.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      reorder(dragId, targetId, before);
      removeDropIndicator();
    });
  }

  function showDropIndicator(targetCard, before){
    removeDropIndicator();
    dropIndicator = document.createElement('div');
    dropIndicator.className = 'drop-indicator';
    if (before) targetCard.parentNode.insertBefore(dropIndicator, targetCard);
    else targetCard.parentNode.insertBefore(dropIndicator, targetCard.nextSibling);
  }
  function removeDropIndicator(){
    if (dropIndicator && dropIndicator.parentNode) dropIndicator.parentNode.removeChild(dropIndicator);
    dropIndicator = null;
  }

  function reorder(srcId, dstId, placeBefore){
    const items = [...state.items].sort((a,b)=>(a.order||0)-(b.order||0));
    const srcIdx = items.findIndex(i=>i.id===srcId);
    const dstIdx = items.findIndex(i=>i.id===dstId);
    if (srcIdx<0 || dstIdx<0) return;

    const [moved] = items.splice(srcIdx,1);
    const insertIdx = placeBefore ? (dstIdx <= srcIdx ? dstIdx : dstIdx) : (dstIdx < srcIdx ? dstIdx+1 : dstIdx+1);
    items.splice(insertIdx, 0, moved);

    // Renumber orders to 10,20,30… to leave space for future inserts (not necessary but tidy)
    items.forEach((it, i)=>{ it.order = (i+1)*10; it.updatedAt = now(); });
    state.items = items;
    save();
    render();
  }

  // --- Tiny toast
  let toastTimer;
  function toast(msg){
    let t = el('#_toast');
    if (!t){
      t = document.createElement('div'); t.id = '_toast';
      t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
      t.style.background='linear-gradient(180deg,#101a28,#0c1522)'; t.style.border='1px solid #25344a'; t.style.padding='10px 14px';
      t.style.borderRadius='10px'; t.style.boxShadow= '0 10px 30px rgba(0,0,0,.4)'; t.style.zIndex='9999'; t.style.opacity='0';
      document.body.appendChild(t);
    }
    t.textContent = msg; t.style.transition='opacity .2s ease, transform .2s ease'; t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(0)';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, 1400);
  }

  // --- Init
  state.items = load();
  seedIfEmpty();
  render();

})();
</script>
</body>
</html>
